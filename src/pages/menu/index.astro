---
import AllergensCard from '@/components/AllergensCard/AllergensCard.astro';
import Container from '@/components/Global/Container.astro';
import FoodCategories from '@/components/Menu/FoodCategories/FoodCategories.astro';
import MenuList from '@/components/Menu/MenuList';
import { MenuOfTheDayLazy } from '@/components/sections/MenuOfTheDay/MenuOfTheDayLazy';
import Layout from '@/layouts/Layout.astro';
import { getMenuData } from '@/lib/getMenuData';
import { useTranslations } from '@/lib/i18n/useTranslations';
import { Image } from 'astro:assets';
import ChickenBanner from '@/assets/images/chicken-banner.webp';
import MenuPageOptimizer from '@/components/MenuPageOptimizer.astro';

const lang = Astro.currentLocale as "es" | "en" | "de";
const t = useTranslations(lang);

// Use consolidated data fetching function - single optimized call with performance monitoring
const startTime = Date.now();
const { categories, dishes, menuOfTheDay, weekMenu } = await getMenuData(lang);
const loadTime = Date.now() - startTime;

// Log performance for debugging
if (loadTime > 500) {
  console.warn(`⚠️ Slow menu data load: ${loadTime}ms for ${lang}`);
} else {
  console.log(`✅ Menu data loaded in ${loadTime}ms for ${lang}`);
}

const categoriesToShow = [...categories].slice(7)
---

<Layout title={`${t("nav.menu")} - La cocina de Vero`}>
    <Container>
        <a href="tel:+34652640538">
          <Image src={ChickenBanner} alt="Chicken Banner" width={1120} height={300} class="object-cover object-center mt-5" />
        </a>
        <div data-component="menu-of-the-day" class="lazy-component">
          <MenuOfTheDayLazy client:idle menuOfTheDay={menuOfTheDay} weekMenu={weekMenu} lang={lang}/>
        </div>
        <div data-component="menu-categories" class="lazy-component">
          <FoodCategories categories={categoriesToShow} />
        </div>
        <div data-component="menu-list" class="lazy-component">
          <MenuList client:only lang={lang} dishes={dishes} categories={categories}/>
        </div>
        <div data-component="allergens-card" class="lazy-component">
          <AllergensCard/>
        </div>
    </Container>
    <MenuPageOptimizer />
</Layout>